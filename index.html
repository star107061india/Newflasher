<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi Auto Bot - Precision Control</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono&display=swap');
        :root {
            --slate-900: #0f172a; --slate-800: #1e293b; --slate-700: #334155;
            --slate-600: #475569; --slate-500: #64748b; --slate-400: #94a3b8;
            --slate-300: #cbd5e1; --slate-50: #f8fafc; --purple-400: #c084fc;
            --purple-500: #a855f7; --purple-600: #9333ea; --pink-500: #ec4899;
            --pink-600: #db2777; --green-400: #4ade80; --red-400: #f87171; --amber-400: #fbbf24;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom right, var(--slate-900), var(--purple-600), var(--slate-900));
            color: var(--slate-50); margin: 0; display: flex; align-items: flex-start; justify-content: center;
            min-height: 100vh; padding: 24px; box-sizing: border-box;
        }
        .container { width: 100%; max-width: 500px; }
        .header { text-align: center; margin-bottom: 24px; }
        .header h1 {
            font-size: 24px; font-weight: 700; margin: 0 0 8px 0;
            color: var(--slate-50);
        }
        .header p { margin: 0; color: var(--slate-300); font-size: 13px; }
        
        /* Tabs */
        .tabs { display: grid; grid-template-columns: 1fr 1fr; background-color: rgba(0,0,0,0.3); border: 1px solid var(--slate-700); border-radius: 8px; padding: 4px; margin-bottom: 20px;}
        .tab-button {
            padding: 10px; border: none; background: transparent; color: var(--slate-300);
            cursor: pointer; font-size: 14px; font-weight: 500; border-radius: 6px;
            transition: background-color 0.2s, color 0.2s;
        }
        .tab-button.active { background-color: var(--purple-600); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Card & Forms */
        .card {
            padding: 20px; background-color: rgba(15, 23, 42, 0.95);
            border: 1px solid var(--slate-700); border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .form-group { margin-bottom: 14px; }
        label { display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: var(--slate-300); }
        input, select {
            width: 100%; background-color: var(--slate-800); color: var(--slate-50);
            border: 1px solid var(--slate-600); padding: 10px; border-radius: 6px;
            box-sizing: border-box; font-size: 14px;
        }
        input:focus, select:focus { outline: none; border-color: var(--purple-500); }

        /* Time Inputs Grid */
        .time-grid { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 8px; }
        .time-box { text-align: center; }
        .time-box input { text-align: center; font-family: 'Roboto Mono', monospace; }
        .time-label { font-size: 10px; color: var(--slate-400); margin-bottom: 4px; display: block; }

        /* Buttons */
        button {
            width: 100%; padding: 12px; border-radius: 6px; border: none;
            background-image: linear-gradient(to right, var(--purple-500), var(--pink-500));
            color: white; font-size: 15px; font-weight: 600; cursor: pointer; margin-top: 10px;
        }
        button.cancel-btn { background-image: linear-gradient(to right, #ef4444, #dc2626); }
        button:disabled { background: var(--slate-700); cursor: not-allowed; opacity: 0.6; background-image: none; }
        
        /* Messages & Logs */
        .message-box { padding: 10px; border-radius: 6px; font-size: 13px; margin-top: 12px; text-align: center; }
        .message-error { background: rgba(239, 68, 68, 0.2); color: #fca5a5; border: 1px solid #7f1d1d; }
        .message-success { background: rgba(34, 197, 94, 0.2); color: #86efac; border: 1px solid #14532d; }
        .message-info { background: rgba(59, 130, 246, 0.2); color: #93c5fd; }
        
        .attempts-box { background: #000; padding: 10px; border-radius: 6px; max-height: 180px; overflow-y: auto; font-family: 'Roboto Mono', monospace; font-size: 11px; margin-top: 15px; border: 1px solid var(--slate-700); }
        .log-success { color: var(--green-400); border-bottom: 1px solid #14532d; padding: 4px 0; }
        .log-fail { color: var(--red-400); border-bottom: 1px solid #7f1d1d; padding: 4px 0; }

        /* Countdown */
        #countdown-container { margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.6); border: 1px solid var(--purple-500); border-radius: 8px; text-align: center; }
        #countdown-display { font-family: 'Roboto Mono', monospace; font-size: 28px; font-weight: 700; color: var(--purple-400); text-shadow: 0 0 10px rgba(168, 85, 247, 0.5); }
        
        .hidden { display: none; }
        .helper-text { font-size: 11px; color: var(--slate-500); margin-top: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header"><h1>Pi Auto Bot</h1><p>Manual Seconds/Milliseconds Control</p></div>
        
        <div class="tabs">
            <button id="tab-discover" class="tab-button active">1. Discover</button>
            <button id="tab-transfer" class="tab-button">2. Transfer</button>
        </div>

        <!-- TAB 1: DISCOVER -->
        <div id="content-discover" class="tab-content active">
            <div class="card">
                <div class="form-group">
                    <label>Wallet Keyphrase (Secret)</label>
                    <input type="password" id="discover-keyphrase" placeholder="Alpha bravo charlie...">
                </div>
                <button id="discover-btn">Find Locked Coins</button>
                <div id="discover-message" class="message-box hidden"></div>
                <div id="locked-coins-list" style="margin-top:10px;"></div>
            </div>
        </div>

        <!-- TAB 2: TRANSFER -->
        <div id="content-transfer" class="tab-content">
            <div class="card">
                
                <!-- SCHEDULER -->
                <div style="background: rgba(255,255,255,0.03); padding: 12px; border: 1px solid var(--slate-600); border-radius: 8px; margin-bottom: 15px;">
                    <div class="form-group" style="display:flex; align-items:center; gap:10px; margin-bottom: 10px;">
                        <input type="checkbox" id="enable-schedule" style="width:auto; margin:0;">
                        <label for="enable-schedule" style="margin:0; cursor:pointer; color: var(--purple-400);">Enable Auto-Start Timer</label>
                    </div>

                    <div id="schedule-inputs" class="hidden">
                        <label>Target Time (Local)</label>
                        <div class="time-grid">
                            <div class="time-box">
                                <span class="time-label">Date & Time (Min)</span>
                                <input type="datetime-local" id="base-time">
                            </div>
                            <div class="time-box">
                                <span class="time-label">Seconds</span>
                                <input type="number" id="target-seconds" min="0" max="59" value="00" placeholder="00">
                            </div>
                            <div class="time-box">
                                <span class="time-label">Millis</span>
                                <input type="number" id="target-millis" min="0" max="999" value="000" placeholder="000">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CONFIGURATION -->
                <div class="form-group">
                    <label>Operation Type</label>
                    <select id="operation-type">
                        <option value="claim_and_transfer">Unlock & Transfer (Claim)</option>
                        <option value="withdrawal">Withdrawal (Simple Send)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label style="color:var(--green-400);">Receiver Address (Public Key)</label>
                    <input type="text" id="receiverAddress" placeholder="GB... (Paste Receiver Address Here)">
                </div>

                <div class="form-group">
                    <label>Sender Keyphrase</label>
                    <input type="password" id="senderMnemonic" placeholder="Enter Locked Wallet Phrase">
                </div>

                <div id="locked-id-group" class="form-group">
                    <label>Locked Balance ID</label>
                    <select id="claimableId"><option value="">-- Select from Discover Tab --</option></select>
                </div>

                <div class="form-group">
                    <label>Fee Mechanism</label>
                    <select id="fee-mechanism">
                        <option value="AUTOMATIC">Automatic</option>
                        <option value="CUSTOM">Custom (Stroops)</option>
                    </select>
                </div>
                
                <div id="custom-fee-group" class="form-group hidden">
                    <input type="number" id="custom-fee" value="1000000" placeholder="Fee in stroops">
                </div>

                <!-- HIDDEN DEFAULTS (Can be enabled if needed) -->
                <div class="hidden">
                    <input type="number" id="withdrawalAmount" value="0.01">
                    <input type="number" id="transactionCount" value="1">
                    <input type="number" id="records-per-attempt" value="1">
                    <select id="fee-type"><option value="LOCKED_ACCOUNT_PAYS">Sender Pays</option></select>
                </div>

                <!-- COUNTDOWN -->
                <div id="countdown-container" class="hidden">
                    <div style="font-size:12px; color:var(--slate-400);">Exact Trigger In:</div>
                    <div id="countdown-display">00:00:00.000</div>
                </div>

                <div id="message-box" class="message-box hidden"></div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button id="submitBtn">Start Process</button>
                    <button id="cancelBtn" class="cancel-btn hidden">Stop</button>
                </div>

                <div id="attempts-container" class="hidden">
                    <div style="display:flex; justify-content:space-between; margin-top:15px;">
                        <h3 style="margin:0; font-size:14px;">Logs</h3>
                        <span id="attempts-counter" style="font-size:12px; color:var(--slate-400);"></span>
                    </div>
                    <div id="attempts-box" class="attempts-box"></div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- State ---
        let lockedBalances = [];
        let shouldStop = false;
        let animationId = null;

        // --- Elements ---
        const els = {
            btnDiscover: document.getElementById('tab-discover'),
            btnTransfer: document.getElementById('tab-transfer'),
            viewDiscover: document.getElementById('content-discover'),
            viewTransfer: document.getElementById('content-transfer'),
            
            // Inputs
            keyDiscover: document.getElementById('discover-keyphrase'),
            keySender: document.getElementById('senderMnemonic'),
            addrReceiver: document.getElementById('receiverAddress'),
            opType: document.getElementById('operation-type'),
            claimId: document.getElementById('claimableId'),
            feeMech: document.getElementById('fee-mechanism'),
            customFee: document.getElementById('custom-fee'),
            customFeeGroup: document.getElementById('custom-fee-group'),
            lockedIdGroup: document.getElementById('locked-id-group'),
            
            // Scheduler
            checkSchedule: document.getElementById('enable-schedule'),
            scheduleBox: document.getElementById('schedule-inputs'),
            baseTime: document.getElementById('base-time'),
            secTime: document.getElementById('target-seconds'),
            milTime: document.getElementById('target-millis'),
            countBox: document.getElementById('countdown-container'),
            countDisp: document.getElementById('countdown-display'),

            // Actions
            btnScan: document.getElementById('discover-btn'),
            btnStart: document.getElementById('submitBtn'),
            btnStop: document.getElementById('cancelBtn'),
            
            // Feedback
            msgBox: document.getElementById('message-box'),
            logBox: document.getElementById('attempts-box'),
            logContainer: document.getElementById('attempts-container')
        };

        // --- Tabs ---
        els.btnDiscover.onclick = () => toggleTab(true);
        els.btnTransfer.onclick = () => toggleTab(false);

        function toggleTab(isDiscover) {
            els.btnDiscover.classList.toggle('active', isDiscover);
            els.btnTransfer.classList.toggle('active', !isDiscover);
            els.viewDiscover.classList.toggle('active', isDiscover);
            els.viewTransfer.classList.toggle('active', !isDiscover);
        }

        // --- Visibility Logic ---
        els.checkSchedule.onchange = () => {
            els.scheduleBox.classList.toggle('hidden', !els.checkSchedule.checked);
            els.btnStart.textContent = els.checkSchedule.checked ? "Schedule Start" : "Start Now";
            
            // Set default time to now + 2 min
            if(els.checkSchedule.checked) {
                const now = new Date();
                now.setMinutes(now.getMinutes() + 2);
                const iso = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                els.baseTime.value = iso;
            }
        };

        els.opType.onchange = () => {
            els.lockedIdGroup.classList.toggle('hidden', els.opType.value === 'withdrawal');
        };

        els.feeMech.onchange = () => {
            els.customFeeGroup.classList.toggle('hidden', els.feeMech.value !== 'CUSTOM');
        };

        // --- Step 1: Discover ---
        els.btnScan.onclick = async () => {
            const mnemonic = els.keyDiscover.value.trim();
            if(!mnemonic) return uiMsg("Enter Keyphrase first", "error", "discover-message");
            
            uiMsg("Scanning...", "info", "discover-message");
            
            try {
                // Mocking response logic - Replace with real fetch
                const res = await fetch('/.netlify/functions/getClaimableBalances', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ mnemonic })
                });
                const data = await res.json();
                
                if(!data.success) throw new Error(data.error || "Failed");

                lockedBalances = data.balances || [];
                
                // Update Select Dropdown
                els.claimId.innerHTML = "";
                lockedBalances.forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b.id;
                    opt.text = `${b.amount} PI (ID: ${b.id.substr(0,5)}...)`;
                    els.claimId.appendChild(opt);
                });

                uiMsg(`Found ${lockedBalances.length} balances. Go to Transfer tab.`, "success", "discover-message");
                
                // Auto-fill sender key if success
                els.keySender.value = mnemonic; 

            } catch(e) {
                uiMsg(e.message, "error", "discover-message");
            }
        };

        // --- Step 2: Start Process ---
        els.btnStart.onclick = () => {
            // 1. Validate Required Fields
            if(!els.addrReceiver.value.trim()) return uiMsg("ERROR: Receiver Address is MISSING!", "error");
            if(!els.keySender.value.trim()) return uiMsg("ERROR: Sender Keyphrase is MISSING!", "error");
            if(els.opType.value === 'claim_and_transfer' && !els.claimId.value) {
                return uiMsg("ERROR: No Locked Balance ID selected. Use Discover tab first.", "error");
            }

            // 2. Schedule Logic
            if(els.checkSchedule.checked) {
                startTimer();
            } else {
                startLoop();
            }
        };

        els.btnStop.onclick = () => {
            shouldStop = true;
            cancelAnimationFrame(animationId);
            uiState(false);
            uiMsg("Stopped by user.", "error");
        };

        function startTimer() {
            if(!els.baseTime.value) return uiMsg("Set Date/Time first", "error");
            
            const base = new Date(els.baseTime.value);
            const secs = parseInt(els.secTime.value) || 0;
            const mils = parseInt(els.milTime.value) || 0;

            // Combine components manually
            const target = new Date(base.getFullYear(), base.getMonth(), base.getDate(), base.getHours(), base.getMinutes(), secs, mils).getTime();
            const now = Date.now();

            if(target <= now) return uiMsg("Time must be in the future", "error");

            shouldStop = false;
            els.countBox.classList.remove('hidden');
            els.btnStart.classList.add('hidden');
            els.btnStop.classList.remove('hidden');
            els.msgBox.classList.add('hidden');

            const tick = () => {
                if(shouldStop) return;
                const diff = target - Date.now();

                if(diff <= 0) {
                    els.countDisp.textContent = "00:00:00.000";
                    startLoop(); // FIRE!
                } else {
                    const h = Math.floor(diff / 3600000).toString().padStart(2,'0');
                    const m = Math.floor((diff % 3600000) / 60000).toString().padStart(2,'0');
                    const s = Math.floor((diff % 60000) / 1000).toString().padStart(2,'0');
                    const ms = (diff % 1000).toString().padStart(3,'0');
                    els.countDisp.textContent = `${h}:${m}:${s}.${ms}`;
                    animationId = requestAnimationFrame(tick);
                }
            };
            tick();
        }

        async function startLoop() {
            shouldStop = false;
            uiState(true);
            els.logBox.innerHTML = "";
            
            let attempt = 1;
            const maxAttempts = 1000; // Limit to prevent browser crash, or make infinite
            
            // PREPARE DATA ONCE
            const opType = els.opType.value;
            const receiver = els.addrReceiver.value.trim();
            const sender = els.keySender.value.trim();
            const feeType = "LOCKED_ACCOUNT_PAYS"; 
            const balanceId = els.claimId.value;
            
            // Amount Logic
            let amountToSend = "0";
            if(opType === 'claim_and_transfer') {
                const bal = lockedBalances.find(b => b.id === balanceId);
                amountToSend = bal ? bal.amount : "0";
            } else {
                amountToSend = document.getElementById('withdrawalAmount').value;
            }

            while(!shouldStop) {
                // Log attempt locally
                const logP = document.createElement('div');
                logP.innerHTML = `<span style="color:#aaa">#${attempt}</span> Sending...`;
                els.logBox.prepend(logP);

                const payload = {
                    senderMnemonic: sender,
                    receiverAddress: receiver,
                    feeType: feeType,
                    feeMechanism: els.feeMech.value,
                    customFee: els.customFee.value,
                    claimableId: balanceId,
                    amount: amountToSend,
                    // Required defaults to stop "Missing Field" errors
                    recordsPerAttempt: 1, 
                    count: 1 
                };

                try {
                    const res = await fetch('/.netlify/functions/submitTransaction', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });
                    
                    if(res.status === 429) {
                        logP.innerHTML += " <span class='log-fail'>Rate Limit (Wait 10s)</span>";
                        await sleep(10000);
                    } else {
                        const data = await res.json();
                        if(data.success) {
                            logP.innerHTML = `<span class='log-success'>#${attempt} SUCCESS: Hash ${data.response?.hash?.substr(0,8)}...</span>`;
                            // Optional: Stop on success
                            // shouldStop = true;
                        } else {
                            logP.innerHTML = `<span class='log-fail'>#${attempt} FAIL: ${data.error || "Unknown"}</span>`;
                        }
                        await sleep(500); // 0.5s delay between hits
                    }
                } catch(e) {
                    logP.innerHTML = `<span class='log-fail'>#${attempt} ERR: ${e.message}</span>`;
                    await sleep(2000);
                }

                attempt++;
            }
            uiState(false);
        }

        // --- Helpers ---
        function uiMsg(msg, type, id = "message-box") {
            const el = document.getElementById(id);
            el.textContent = msg;
            el.className = `message-box message-${type}`;
            el.classList.remove('hidden');
        }

        function uiState(isRunning) {
            els.btnStart.classList.toggle('hidden', isRunning);
            els.btnStop.classList.toggle('hidden', !isRunning);
            els.logContainer.classList.toggle('hidden', !isRunning && els.logBox.innerHTML === "");
            els.countBox.classList.add('hidden');
        }

        const sleep = (ms) => new Promise(r => setTimeout(r, ms));

        // Init
        els.opType.dispatchEvent(new Event('change'));
    </script>
</body>
</html>
